language: node_js
node_js:
    - "12"

cache: yarn

install:
    - yarn global add lerna jest
    - lerna bootstrap

script:
    - yarn build
    - yarn test

before_deploy:
    - echo "registry=https://registry.npmjs.org/" > ~/.npmrc
    - echo "email=${NPM_EMAIL}" >> ~/.npmrc
    - echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" >> ~/.npmrc

deploy:
    - provider: script
      script: yarn run pack && yarn run deploy
      on:
          tags: true
          branch: master

after_deploy:
    - rm ~/.npmrc
