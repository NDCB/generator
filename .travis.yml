language: node_js
node_js:
  - "10"

os: linux

branches:
  except:
    - gh-pages

cache: yarn

stages:
  - build
  - test
  - deploy

jobs:
  include:
    - stage: build
      script:
        - yarn run build
    - stage: test
      before_script:
        - curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
        - chmod +x ./cc-test-reporter
        - ./cc-test-reporter before-build
      script: yarn run coverage
      after_success:
        - ./cc-test-reporter after-build
    - stage: deploy
      if: tag IS present
      script:
        - yarn run build
        - yarn pack
        - yarn run doc
      deploy:
        - provider: pages
          github_token: $GITHUB_TOKEN
          local_dir: ./doc/
          keep_history: true
          verbose: true
          skip_cleanup: true
          on:
            tags: true
        - provider: releases
          api_key: $GITHUB_TOKEN
          file_glob: true
          file: "*.tgz"
          skip_cleanup: true
          on:
            tags: true

notifications:
  email:
    on_success: always
    on_failure: always
    recipients:
      - ouimetmarcantoine@gmail.com
